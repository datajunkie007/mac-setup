#!/bin/bash
set -x
# small script to create local port forwards

# to create local port forwards

CLUSTER=$1
if [ "${CLUSTER}x" = "x" ] ; then
	echo "ERROR: Must specify the Maiden cluster"
	echo "Usage: $0 cluster"
	echo "Example: $0 qc2"
	exit 1	
fi

PORTS="001:50070 001:60010 003:50030 001:80 002:50090"

for x in $PORTS
do
	LOCAL_PORT=`echo "${x}" | cut -d: -f2`
	OLD_ONE=`ps auxwww | grep ssh | egrep -- "-L ${LOCAL_PORT}" | awk '{print $2}' 2>&1 `
	if [ "${OLD_ONE}x" != "x" ] ; then
		echo "Killing old forward for port ${LOCAL_PORT}"
		if [ ${LOCAL_PORT} -le 1024 ] ; then
			sudo kill -9 ${OLD_ONE}
		else
			kill -9 ${OLD_ONE}
		fi
	fi
	FORWARD="${LOCAL_PORT}:st11p01ad-${CLUSTER}${x}"
	echo "Adding forward ${FORWARD}"
	if [ ${LOCAL_PORT} -le 1024 ] ; then
		sudo ssh -f rphulari@REPLACESERVER -L $FORWARD -N
	else
		ssh -f REPLACESERVER -L $FORWARD -N
	fi
done

